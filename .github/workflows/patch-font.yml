name: Patch Nerd Fonts Families & Release

on:
  push:
    branches:
      - main
    # paths:
    #   - 'fonts/**'

jobs:
  patch-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # needed to create releases

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Install dependencies
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y python3 python3-pip fontforge python3-fontforge unzip curl zip gh jq

      # 3️⃣ Download FontPatcher.zip
      - name: Download FontPatcher
        run: |
          curl -L -o FontPatcher.zip https://github.com/ryanoasis/nerd-fonts/releases/latest/download/FontPatcher.zip
          unzip -o FontPatcher.zip
          chmod +x font-patcher

      # 4️⃣ Patch, convert, and zip each font family
      - name: Patch and package font families
        run: |
          mkdir -p patched

          for family_dir in fonts/*/; do
            family_name=$(basename "$family_dir")
            echo "Processing family: $family_name"

            workdir=$(mktemp -d)
            outdir="patched/$family_name"
            mkdir -p "$outdir"

            for font_file in "$family_dir"*.[oOtT][tTfF][fF]; do
              [ -f "$font_file" ] || continue
              echo "Patching $font_file ..."

              cp "$font_file" "$workdir/"
              pushd "$workdir" >/dev/null

              python3 "$GITHUB_WORKSPACE/font-patcher" "$(basename "$font_file")" \
                --complete \
                --careful \
                --adjust-line-height \
                --mono

              # Move all patched outputs
              mv *Nerd\ Font* "$GITHUB_WORKSPACE/$outdir/" || true

              popd >/dev/null
            done

            # Convert OTF → TTF (Termux-safe)
            for f in "$outdir"/*.otf; do
              [ -f "$f" ] || continue
              fontforge -lang=ff -c "Open(\"$f\"); Generate(\"${f%.otf}.ttf\")"
            done

            # Zip family
            zip -r "patched/$family_name.zip" "$outdir" >/dev/null

            rm -rf "$workdir"
          done
      # 5️⃣ Create GitHub releases for each font family
      - name: Create releases per font family
        run: |
          for zipfile in patched/*.zip; do
            family_name=$(basename "$zipfile" .zip)
            tag="nerdfont-${family_name}-${GITHUB_SHA::7}"

            echo "Creating release for $family_name with tag $tag"

            # Create release if it doesn't exist
            gh release view "$tag" >/dev/null 2>&1 || \
              gh release create "$tag" "$zipfile" \
                --title "$family_name Nerd Font" \
                --notes "Automatically generated Nerd Font patch for $family_name"
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
